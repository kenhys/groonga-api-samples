# テーブルの `--value_type` について

テーブルは`--value_type`を指定すると`_value`カラムが作成されます。

このカラムは、ユーザーが`_value`カラムに任意の値を設定して使うこともできますが、
レコードの再利用のためにも実は使われています。(すくなくともTABLE_NO_KEYの実装はそうなっています。）

レコードの再利用の仕組みは次の通りです。

テーブルの`header->garbages`に削除されたレコードの先頭のIDを格納します。
そのIDを使って削除されたレコードの`_value`をたどると、次の削除されたレコードのIDが格納されています。
順番に `_value` をたどっていくと削除されたレコードがリストとしてたどれるようになっています。

レコードを削除するときは、前に削除したレコードのID(`header->garbages`に設定されている)を`_value`に設定し、
`header->garbages`に新たに削除するIDを設定します。

このようにしてレコードを再利用する仕組みになっているので、`_value` カラムがないと再利用できません。

# カラムの追加と削除について(固定長)

固定長の場合には、IDに対応する位置にレコードを作成します。

前述のように、`_value`カラムがない場合、レコードが再利用されないため、
固定長型のカラムでは、ID増えれば増えるほど対応するIDの位置に領域を確保する挙動になるため
そのぶん使用領域が増えます。

したがって、同じデータをロードしなおすとそのぶんデータベースが肥大化することになります。

# カラムの追加と削除について(可変長)

可変長の場合には、固定長のようにあらかじめ決まった位置にレコードを作成することが
できないため、実データを格納している場所への参照情報を記録していきます。

前述のように、`_value`カラムがない場合、レコードが再利用されないため、
可変長の型のカラムでは、ID増えれば増えるほど対応する参照情報を格納する領域が必要となりますが、
参照する情報はコンパクトに格納できるのと、実データは再利用されるのでそれほどデータベースは肥大化しません。

# インデックスカラムについて

インデックスにはバッファーとチャンクと呼ばれるものの2つがあります。
どちらもポスティングリストを保持しています。

レコードの削除によりインデックスを更新する必要がある場合、
トークンがどの文書に何回出現しているかというtfの値を0に書き換えます。

ただし、チャンクから削除するときは、チャンクは変更不可なので、バッファーにコピーを
作成してそのtfの値を0にします。バッファーとチャンクのどちらにもデータがある場合、
バッファーが優先されるようになっているので動作に支障はありません。

ただし、このように更新されていくとバッファーがいずれいっぱいになります。
するとバッファーを分割します。このとき、tf=0は無視してチャンクが作られます。

レコードの削除にともなってバッファーが追加されていくため、レコードを
削除したからといってデータベースが小さくなるわけではなく、しだいに肥大化します。

この仕組みのため、インデックスの更新の対象でバッファーが多ければあまり肥大化しませんが、
チャンクからバッファーへのコピーが多ければ、肥大化の程度は大きくなります。
